# Civitai Model Downloader 要件定義書

## 1. プロジェクト概要

### 1.1 目的
Civitai.com APIを使用して、特定条件に合致するAIモデル（CheckpointおよびLoRA）を自動的に検索・ダウンロードするツールを開発する。

### 1.2 背景
- AI画像生成において、高品質なモデルの取得が重要
- 手動でのモデル検索・ダウンロードは時間がかかる
- 特定の条件（タグ、タイプ）でフィルタリングした効率的な取得が必要

## 2. 機能要件

### 2.1 モデル検索機能
- **FR-001**: Civitai APIを使用したモデル検索
  - Checkpointタイプのモデル検索
  - LoRAタイプのモデル検索
  - タグベースのフィルタリング

- **FR-002**: 検索条件
  - Checkpoint: すべてのCheckpointモデルが対象
  - LoRA: 以下の条件をすべて満たすもの
    - タグに「pony」「illustrious」「noobai」のいずれかを含む
    - タグに「style」または「concept」を含む

- **FR-003**: 検索結果の管理
  - 重複モデルの除外
  - 評価順/ダウンロード数順でのソート
  - ページネーション対応

### 2.2 URL探知機能
- **FR-008**: モデルURL収集機能
  - 検索条件に合致するモデルのダウンロードURL収集
  - URLリストのテキストファイル出力
  - モデル情報（名前、タイプ、タグ）を含むCSV形式での出力オプション

- **FR-009**: ダウンロード制御
  - 環境変数によるダウンロード実行の制御
  - URL探知のみモード（デフォルト）
  - ダウンロード実行モード（.env設定時）

### 2.3 モデルダウンロード機能
- **FR-004**: 自動ダウンロード
  - モデルファイル（.safetensors形式）のダウンロード
  - プログレス表示
  - 中断・再開機能

- **FR-005**: ファイル管理
  - モデルタイプ別のディレクトリ管理
  - 安全なファイル名の生成
  - ダウンロード済みファイルのスキップ

### 2.4 データ管理機能
- **FR-006**: モデル情報の保存
  - メタデータ（名前、作者、タグ、URL）の記録
  - JSON形式でのエクスポート
  - ダウンロード履歴の管理

### 2.5 ユーザーインターフェース
- **FR-007**: CLI（コマンドラインインターフェース）
  - 対話的な設定入力
  - バッチ実行モード
  - 進捗状況の表示

## 3. 非機能要件

### 3.1 性能要件
- **NFR-001**: レスポンス時間
  - API呼び出しのタイムアウト: 30秒
  - ダウンロードタイムアウト: 5分

- **NFR-002**: スループット
  - 同時ダウンロード数: 1（レート制限対策）
  - API呼び出し間隔: 最小2秒

### 3.2 信頼性要件
- **NFR-003**: エラーハンドリング
  - ネットワークエラーの適切な処理
  - API認証エラーの検出と通知
  - レート制限エラーの自動リトライ

- **NFR-004**: データ整合性
  - ダウンロード中断時のファイル破損防止
  - メタデータとファイルの整合性確保

### 3.3 セキュリティ要件
- **NFR-005**: 認証情報の保護
  - APIキーの環境変数管理
  - 設定ファイルでの暗号化保存オプション

### 3.4 使用性要件
- **NFR-006**: ドキュメント
  - インストール手順書
  - 使用方法ガイド
  - API設定手順

- **NFR-007**: エラーメッセージ
  - 日本語でのわかりやすいエラー表示
  - 解決方法の提示

## 4. 制約事項

### 4.1 技術的制約
- Python 3.8以上またはNode.js 16以上
- Civitai API v1の仕様に準拠
- インターネット接続必須

### 4.2 運用制約
- Civitai APIキーの事前取得が必要
- ローカルストレージの空き容量（モデル1つあたり2-8GB）

## 5. 前提条件
- ユーザーはCivitaiアカウントを保有
- 基本的なコマンドライン操作の知識
- 十分なディスク容量（推奨: 50GB以上）

## 6. 用語定義
- **Checkpoint**: ベースモデル（完全な画像生成モデル）
- **LoRA**: Low-Rank Adaptation（軽量な追加学習モデル）
- **safetensors**: 安全性を重視したモデルファイル形式
- **タグ**: モデルの特徴を表すキーワード

## 7. 成功基準
- 指定条件のモデルを95%以上の精度で検索
- ダウンロード成功率90%以上
- エラー発生時の自動復旧率80%以上