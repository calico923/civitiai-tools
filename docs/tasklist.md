# Civitai Model Downloader - TDD実装タスクリスト

## 概要
このタスクリストは、Test-Driven Development（TDD）アプローチに基づいてCivitai Model Downloaderを実装するためのものです。各機能について「テスト作成→実装→リファクタリング」の順で開発を進めます。

## Phase 1: 基盤構築（2日）

### 1.1 プロジェクト構造とテスト環境
- [ ] **Test**: 最小動作テスト（TDD最初の一歩）
  - `src/main.py`の`hello()`関数が`"Hello, Civitai!"`を返すテスト (`tests/test_main.py`)
  - pytestが正しく動作すること、importパスが通ることを確認
- [ ] **Implement**: 最小のプロダクトコード実装
  - テストをパスする`src/main.py`と`hello()`関数の実装
  - プロジェクトディレクトリ構造の作成
- [ ] **Test**: pytest設定とテスト実行環境の確認
  - 設定ファイルの動作確認
  - テストカバレッジ機能の確認
- [ ] **Implement**: 開発環境の完整
  - `pytest.ini`、`requirements.txt`、`.gitignore`の作成
- [ ] **Refactor**: プロジェクト構造の最適化

### 1.2 設定管理システム
- [ ] **Test**: 設定ファイル読み込みテスト
  - `config.yaml`の存在確認
  - 環境変数オーバーライドの動作確認
- [ ] **Implement**: 設定管理クラスの実装
- [ ] **Refactor**: 設定値の型安全性確保

### 1.3 ロギングシステム
- [ ] **Test**: ログ出力テスト
  - ファイル・コンソール出力の確認
  - ログレベル別出力の確認
- [ ] **Implement**: ロガー設定の実装
- [ ] **Refactor**: ログフォーマットの統一

## Phase 2: API統合（3日）

### 2.1 APIクライアント基本機能
- [ ] **Test**: `CivitaiClient`初期化テスト
  - APIキー設定の確認
  - セッション作成の確認
- [ ] **Implement**: `CivitaiClient`クラスの基本実装
- [ ] **Test**: HTTPリクエストモックテスト
  - 正常レスポンスの処理
  - エラーレスポンスの処理
- [ ] **Implement**: 基本的なHTTPリクエスト機能

### 2.2 モデル検索機能
- [ ] **Test**: モデル検索APIテスト
  - パラメータ付きリクエストの確認
  - レスポンス解析の確認
- [ ] **Implement**: `search_models`メソッドの実装
- [ ] **Test**: ページネーション処理テスト
  - 複数ページ取得の確認
  - 終了条件の確認
- [ ] **Implement**: ページネーション機能の実装

### 2.3 レート制限とエラーハンドリング
- [ ] **Test**: レート制限テスト
  - 429エラーのハンドリング確認
  - 待機時間の計算確認
- [ ] **Implement**: `RateLimiter`クラスの実装
- [ ] **Test**: リトライロジックテスト
  - 指数バックオフの動作確認
  - 最大リトライ回数の確認
- [ ] **Implement**: リトライ機能の実装

## Phase 3: コア機能実装（3-4日）

### 3.1 モデルフィルタリング
- [ ] **Test**: `ModelFilter`初期化テスト
- [ ] **Implement**: `ModelFilter`クラスの基本実装
- [ ] **Test**: LoRAフィルタリングテスト
  - タグベースフィルタリングの確認
  - 複数条件の組み合わせ確認
- [ ] **Implement**: `filter_lora_models`メソッドの実装
- [ ] **Test**: 重複排除テスト
  - モデルID重複の除去確認
- [ ] **Implement**: `remove_duplicates`メソッドの実装

### 3.2 URL収集機能
- [ ] **Test**: `URLCollector`初期化テスト
  - 出力ディレクトリ作成の確認
  - 設定値の正常な読み込み確認
- [ ] **Implement**: `URLCollector`クラスの基本実装
- [ ] **Test**: URL収集テスト（モック使用）
  - モックされたモデルデータからURL情報抽出の確認
  - `URLInfo`データ構造の各フィールド正確性確認
  - 不正なモデルデータのハンドリング確認
- [ ] **Implement**: `collect_model_urls`メソッドの実装
- [ ] **Test**: 出力形式テスト
  - テキスト、CSV、JSON各形式での出力確認
  - ファイル内容の形式とエンコーディング確認
  - 空のURLリストでの出力動作確認
- [ ] **Implement**: 各種出力メソッドの実装

### 3.3 ダウンロード履歴管理
- [ ] **Test**: `DownloadHistory`初期化テスト
  - データベース作成の確認
  - テーブル構造の確認
- [ ] **Implement**: `DownloadHistory`クラスとDB初期化
- [ ] **Test**: 履歴追加テスト
  - レコード挿入の確認
  - 重複処理の確認
- [ ] **Implement**: `add_download`メソッドの実装
- [ ] **Test**: 履歴検索テスト
  - ダウンロード済み確認
  - 条件付き検索の確認
- [ ] **Implement**: `is_downloaded`、`list_downloads`メソッドの実装

### 3.4 ダウンロード機能（基本実装）
- [ ] **Test**: `ModelDownloader`初期化テスト
  - コンストラクタの動作確認
  - 設定値の初期化確認
- [ ] **Implement**: `ModelDownloader`クラスの基本実装
- [ ] **Test**: 基本ダウンロードテスト
  - 小サイズファイルの完全ダウンロード確認
  - プログレスバー表示の動作確認
  - ファイル保存パスの正確性確認
- [ ] **Implement**: `download_file`メソッドの基本実装
  - 中断・再開機能を含まないシンプルな実装
- [ ] **Refactor**: ダウンロードロジックのクリーンアップ

### 3.5 ダウンロード機能（中断・再開）
- [ ] **Test**: 中断・再開機能テスト
  - 部分的にダウンロード済みファイルの検出確認
  - HTTPの`Range`ヘッダーを使った再開リクエスト確認
  - 再開後の完全ダウンロード確認
- [ ] **Implement**: `download_file`メソッドへの中断・再開機能追加
  - 既存ファイルサイズの確認
  - `Range`ヘッダーの設定
  - 追記モードでのファイル保存
- [ ] **Refactor**: 複雑になったロジックの整理と最適化

## Phase 4: CLI開発（1日）

### 4.1 CLI基本構造
- [ ] **Test**: CLI引数解析テスト
  - 各オプションの解析確認
  - ヘルプメッセージの確認
- [ ] **Implement**: Click-based CLIの実装
- [ ] **Test**: サブコマンドテスト
  - `search`、`download`、`list-history`コマンドの確認
- [ ] **Implement**: サブコマンド機能の実装

### 4.2 統合ワークフロー
- [ ] **Test**: メインワークフローテスト
  - URL収集モードの動作確認
  - ダウンロードモードの動作確認
  - 環境変数による動作切り替え確認
- [ ] **Implement**: メイン処理ロジックの実装
- [ ] **Test**: エラーハンドリング統合テスト
  - ネットワークエラー時の動作
  - ディスク容量不足時の動作
- [ ] **Implement**: 統合エラーハンドリング

## Phase 5: テストとドキュメント（1日）

### 5.1 統合テスト
- [ ] **Test**: エンドツーエンドテスト
  - 実際のAPI呼び出しテスト（sandbox環境）
  - 完全なワークフローテスト
- [ ] **Test**: パフォーマンステスト
  - 大量モデル処理のテスト
  - メモリ使用量の確認
- [ ] **Test**: エラーケースの網羅テスト
  - ネットワーク断絶時の動作
  - 不正な設定値での動作

### 5.2 ドキュメント
- [ ] **Create**: README.mdの作成
  - インストール手順
  - 基本的な使用方法
- [ ] **Create**: API設定ガイドの作成
- [ ] **Create**: トラブルシューティングガイドの作成

## TDD実装方針

### Red-Green-Refactorサイクル
1. **Red**: 失敗するテストを書く（仕様の明確化）
2. **Green**: テストをパスする最小限のコードを書く（動作確認）
3. **Refactor**: コードをクリーンにする（品質向上）

### TDD効果的な実践ポイント
- **最小単位での実装**: 1つの機能を複数の小さなTDDサイクルに分割
- **モックファーストアプローチ**: 依存関係をモックで分離してから実装
- **テストケース駆動設計**: テストケースから必要なインターフェースを導出
- **継続的リファクタリング**: Green段階での最小実装後、必ずRefactor段階を実行

### テスト戦略
1. **ユニットテスト**: 各クラス・メソッドの独立したテスト
2. **統合テスト**: コンポーネント間の連携テスト
3. **E2Eテスト**: 実際のAPIを使用した完全なワークフローテスト

### モックとフィクスチャ
- **APIレスポンス**: `tests/fixtures/`にサンプルレスポンスを保存
- **ファイル操作**: 一時ディレクトリを使用した分離されたテスト環境
- **データベース**: SQLite in-memoryでの高速テスト
- **依存関係の分離**: 
  - `CivitaiClient`のモック：APIコール数制限なしでのテスト実行
  - `DownloadHistory`のモック：データベース状態に影響されないテスト
  - `ModelFilter`のモック：フィルタリングロジックから独立したテスト
- **モックデータ設計**:
  - 実際のCivitai APIレスポンス構造に基づくモックデータ
  - エラーケース（不正データ、欠損フィールド）を含む包括的なテストデータ
  - 境界値テスト用のデータセット

### テスト実行
```bash
# 全テスト実行
pytest

# カバレッジ付き実行
pytest --cov=src

# 特定フェーズのテスト
pytest tests/test_api.py
pytest tests/test_downloader.py
```

### 継続的な品質確保
- [ ] **Setup**: pre-commitフックの設定
- [ ] **Setup**: CI/CDパイプラインの設定（GitHub Actions）
- [ ] **Setup**: コードカバレッジ目標の設定（80%以上）

## 実装優先度
1. **High**: API統合、フィルタリング、URL収集
2. **Medium**: ダウンロード機能、履歴管理
3. **Low**: CLI改善、パフォーマンス最適化

## 完了条件
- [ ] 全テストがパス（カバレッジ80%以上）
- [ ] 実際のCivitai APIで動作確認
- [ ] ドキュメントの完成
- [ ] エラーハンドリングの完全性確認
- [ ] レビュー提案項目の実装確認
  - TDD最小実装サイクルの実践
  - 段階的機能実装の完了
  - モック・依存関係分離の実装