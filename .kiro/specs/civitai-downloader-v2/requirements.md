# 要件定義書

## 概要

本文書は、事前調査フェーズで実施された包括的なAPI研究の成果を活用して、ゼロから構築するCivitai Model Downloader v2の要件を定義します。このツールは、Civitai.comからAIモデルを効率的に発見、収集、ダウンロードする機能を提供し、公式・非公式のAPI機能を最大限活用してカバレッジと効率性を最大化します。

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、包括的な検索条件を使用してCivitaiからAIモデルを検索・発見したい。プロジェクトに最も関連性の高いモデルを見つけるために。

#### 受入基準

1. 検索条件を指定するとき、システムは公式・発見済みAPIパラメータの両方を使用して検索すること
2. モデルを検索するとき、システムは発見済みの全13種類のモデルタイプ（Checkpoint、LORA、LoCon、DoRA、TextualInversionなど）をサポートすること
3. ベースモデルでフィルタリングするとき、システムはIllustrious、NoobAI、Pony、SDXLなどを含む50以上の発見済みベースモデルをサポートすること
4. タグを適用するとき、システムは直接タグ検索と発見済みの15カテゴリの両方をサポートすること
5. 結果をソートするとき、システムは発見済みの全10種類のソートオプション（Highest Rated、Most Downloaded、Most Likedなど）をサポートすること
6. 期間を指定するとき、システムは5つの期間フィルター（Day、Week、Month、Year、AllTime）をサポートし、統計ベースのソートと組み合わせて使用すること
7. 検索するとき、システムは重複なしで完全なデータ取得を保証するためにカーソルベースページネーションを使用すること

### 要件2

**ユーザーストーリー:** ユーザーとして、包括的なモデル情報とURLを収集したい。ダウンロード前にモデルを分析・整理するために。

#### 受入基準

1. モデル情報を収集するとき、システムはモデルごとに発見済みの85以上のAPIフィールドをすべて収集すること
2. モデルデータをエクスポートするとき、システムは複数の形式（JSON、YAML、CSV、Markdown、HTML、テキスト）をサポートすること
3. URLを収集するとき、システムはダウンロードURLを検証してメタデータを抽出すること
4. 収集を実行するとき、システムは見逃しモデルを最小化するためにデュアル検索戦略を実装すること
5. 結果を処理するとき、システムはモデルIDに基づいてインテリジェントな重複除去を実行すること
6. データをエクスポートするとき、システムは包括的なメタデータ（タグ、作成者、統計、ファイル情報、ライセンス情報、セキュリティスキャン結果）を含めること

### 要件3

**ユーザーストーリー:** ユーザーとして、適切な整理でモデルを効率的にダウンロードしたい。モデルライブラリを効果的に管理するために。

#### 受入基準

1. モデルをダウンロードするとき、システムは主要モデルタイプ（Checkpoint、LORA、LoCon等）別にディレクトリを作成してファイルを整理し、SafeTensors形式を優先してダウンロードすること
2. ダウンロード中、システムは進捗インジケータを表示し、中断を適切に処理すること
3. ダウンロードが失敗するとき、システムは指数バックオフリトライロジックを実装すること
4. 再開するとき、システムは部分ダウンロードの再開をサポートすること
5. ダウンロードするとき、システムは設定可能な遅延でレート制限を尊重し、同時ダウンロード数を1に制限すること
6. ファイルが存在するとき、システムは履歴に基づいて既にダウンロード済みのモデルをスキップし、ファイルが存在しない場合は失敗状態として記録してスキップすること

### 要件4

**ユーザーストーリー:** ユーザーとして、制限付きおよびユーザー固有のモデルにアクセスしたい。プライベートコレクションを含む包括的なモデルセットを収集するために。

#### 受入基準

1. 認証情報を提供するとき、システムはセッション管理を使用してCivitaiで認証すること
2. ユーザー名を指定するとき、システムはそのユーザーのすべての公開モデルを収集すること
3. 認証されているとき、システムは自分のアカウントで利用可能な制限付きモデルにアクセスすること
4. スクレイピングが有効なとき、システムはAPI制限の代替手段としてウェブスクレイピングを使用すること
5. ユーザーモデルを収集するとき、システムはAPIとスクレイピング結果をインテリジェントに組み合わせること
6. セッションが期限切れになるとき、システムは自動的に再認証すること

### 要件5

**ユーザーストーリー:** ユーザーとして、包括的な検索戦略と分析を求める。すべてのカテゴリにわたってモデルを体系的に発見するために。

#### 受入基準

1. 包括的検索を実行するとき、システムはベースモデル、タイプ、タグにわたって体系的な検索を実行すること
2. 検索するとき、システムはデュアル検索戦略（直接タグ + ベースモデルフィルタリング）を実装すること
3. 結果を分析するとき、システムは詳細な統計と重複分析を提供すること
4. 体系的に検索するとき、システムは進捗追跡付きのバッチ処理をサポートすること
5. 検索を設定するとき、システムはカスタマイズ可能な検索パラメータ（期間フィルター、ソート、制限値）を許可すること
6. 検索が完了するとき、システムは可視化付きの包括的なレポートを生成すること

### 要件6

**ユーザーストーリー:** ユーザーとして、堅牢なデータ管理と履歴追跡を求める。整理された効率的なワークフローを維持するために。

#### 受入基準

1. モデルをダウンロードするとき、システムはダウンロード履歴のSQLiteデータベースを維持すること
2. 履歴を確認するとき、システムは重複ダウンロードを防止してステータスを表示すること
3. データを管理するとき、システムは孤立したレコードとファイルのクリーンアップをサポートし、ファイルが存在しない履歴レコードを失敗状態として記録・管理すること
4. データをエクスポートするとき、システムはモデルとファイル間の参照整合性を維持すること
5. 履歴を照会するとき、システムは日付、タイプ、ステータスによるフィルタリングをサポートすること
6. データをバックアップするとき、システムは完全な履歴のエクスポート/インポートをサポートすること

### 要件7

**ユーザーストーリー:** ユーザーとして、柔軟な設定と制御オプションを求める。異なる使用ケースに合わせてツールをカスタマイズするために。

#### 受入基準

1. ツールを設定するとき、システムは環境変数と設定ファイルをサポートすること
2. モードを設定するとき、システムはURLのみモード対フルダウンロードモードをサポートすること
3. 出力を指定するとき、システムは設定可能な出力ディレクトリと形式をサポートすること
4. 制限を設定するとき、システムは設定可能なレート制限、タイムアウト、最大ダウンロード数を尊重すること
5. 機能を有効にするとき、システムはオプションのウェブスクレイピングと認証をサポートすること
6. コマンドを実行するとき、システムはヘルプと検証付きの包括的なCLIを提供すること

### 要件8

**ユーザーストーリー:** 開発者として、包括的なエラーハンドリングとロギングを求める。問題をトラブルシューティングしてパフォーマンスを監視するために。

#### 受入基準

1. エラーが発生するとき、システムはコンテキスト付きの詳細なエラーメッセージを提供すること
2. API制限に達するとき、システムはインテリジェントなバックオフとリトライを実装すること
3. 実行を監視するとき、システムは複数レベルでの包括的なロギングを提供すること
4. 障害が発生するとき、システムはネットワーク、認証、解析エラーを適切に処理すること
5. デバッグするとき、システムは有効時に詳細なリクエスト/レスポンスロギングを提供すること
6. パフォーマンスを分析するとき、システムはAPI使用量、タイミング、成功率を追跡すること

### 要件9

**ユーザーストーリー:** ユーザーとして、モデルのライセンス情報とセキュリティ状態を確認したい。法的コンプライアンスと安全性を確保するために。

#### 受入基準

1. モデル情報を収集するとき、システムは4つのライセンスフィールド（allowCommercialUse、allowDerivatives、allowDifferentLicense、allowNoCredit）を取得すること
2. ファイル情報を取得するとき、システはウイルススキャンとPickleスキャンの結果を含めること
3. ダウンロード前に、システムはセキュリティスキャンの結果を表示してユーザーに警告すること
4. ファイルを検証するとき、システムは利用可能な6種類のハッシュアルゴリズムを使用してファイル整合性を確認すること
5. エクスポート時に、システムはライセンス情報を明確に表示して法的コンプライアンスを支援すること
6. 商用利用可能なモデルを検索するとき、システムはライセンス条件に基づいてフィルタリング機能を提供すること

### 要件10

**ユーザーストーリー:** 開発者として、高度な検索パラメータを使用してモデルを精密にフィルタリングしたい。特定の条件に完全に合致するモデルのみを効率的に発見するために。

#### 受入基準

1. 高度なフィルタリングを使用するとき、システムはダウンロード数範囲指定（minDownloads、maxDownloads）による絞り込みをサポートすること
2. 期間を指定するとき、システムは日付範囲フィルタ（startDate、endDate）による詳細な期間指定検索を提供すること
3. コンテンツを制御するとき、システムはNSFWコンテンツフィルタリング（nsfwパラメータ）を実装すること
4. 品質を保証するとき、システムは検証済みモデル（verified）、注目モデル（featured）のフィルタリングをサポートすること
5. 商用利用を検索するとき、システムは商用利用可能モデル（commercial）の専用フィルタを提供すること
6. ファイル形式を選択するとき、システムはSafeTensors形式を優先し、Pickle形式は条件付きで対応し、セキュリティスキャン結果を考慮すること

### 要件11

**ユーザーストーリー:** ユーザーとして、カテゴリベースの分類とカスタムソート機能を使用したい。用途別に整理されたモデルコレクションを構築するために。

#### 受入基準

1. カテゴリで検索するとき、システムは15種類のカテゴリ（character、style、concept、background、poses、vehicle、clothing、action、animal、assets、base model、buildings、celebrity、objects、tool）をサポートすること
2. 複合検索を実行するとき、システムはカテゴリ×タグ×モデルタイプの3重フィルタリング機能を提供すること
3. カスタムソートを使用するとき、システムはsortByシステムによるチップ数順（metrics.tippedAmountCount:desc）などの高度なソートをサポートすること
4. ソートが失敗するとき、システムは公式ソートオプションへ自動的にフォールバックすること
5. カテゴリを処理するとき、システムはカテゴリがタグシステム内に統合されていることを考慮した実装を行うこと
6. ベースモデルを指定するとき、システムは50以上のベースモデル（Illustrious、NoobAI、Pony、SDXL 1.0等）の動的検出と未知モデルへの対応をサポートすること

### 要件12

**ユーザーストーリー:** 開発者として、非公式API機能を安全に管理したい。APIの最大限の機能を活用しながらシステムの安定性を維持するために。

#### 受入基準

1. API機能を管理するとき、システムは公式機能優先モードと非公式機能の段階的有効化オプションを提供すること
2. リスクを評価するとき、システムは機能別リスクレベル（高・中・低）を管理し、適切な使用戦略を実装すること
3. 機能を検出するとき、システムはAPI機能の動的検出システムを実装し、利用可能な機能を自動識別すること
4. エラーが発生するとき、システムは非公式機能失敗時の自動フォールバックと段階的デグレード（拡張→公式→基本）を実行すること
5. API仕様が変更されるとき、システムは変更を自動検知し、適切な対応策を実行すること
6. 統計を収集するとき、システムは公式・非公式機能の使用率、成功率、エラー率を追跡すること

### 要件13

**ユーザーストーリー:** ユーザーとして、システムのパフォーマンスと使用状況を監視したい。APIの効率的な利用と問題の早期発見のために。

#### 受入基準

1. 使用状況を追跡するとき、システムはAPI呼び出し回数、成功率、失敗率、エンドポイント別応答時間を測定すること
2. パフォーマンスを最適化するとき、システムはAPI応答の15分間キャッシュと重複APIコールの削減を実装すること
3. バッチ処理を実行するとき、システムは最大200件/ページの制限を考慮した効率的な処理を行うこと
4. 統計を分析するとき、システムはダウンロード速度、ファイルサイズ、モデルタイプ別の統計を提供すること
5. レポートを生成するとき、システムは日次・週次・月次の使用状況レポートを作成すること
6. 制限に対応するとき、システムは個別処理の必須実装（バルク操作不可）とメモリ効率を考慮した逐次処理を行うこと

### 要件14

**ユーザーストーリー:** セキュリティ意識の高いユーザーとして、プライバシーとデータの安全性を確保したい。個人情報の保護と安全なモデル利用のために。

#### 受入基準

1. プライバシーを保護するとき、システムは個人情報を含む可能性のあるモデルを識別し、適切な警告を表示すること
2. セレブリティモデルを扱うとき、システムは特別な取り扱い注意事項を表示し、ユーザーの同意を求めること
3. 履歴を管理するとき、システムはダウンロード履歴のプライバシー保護機能を実装すること
4. データを保存するとき、システムはユーザー生成コンテンツの適切な処理とセキュアな保存を行うこと
5. 設定を管理するとき、システムは認証情報の暗号化保存オプションを提供すること
6. 監査を実行するとき、システムはセキュリティ関連のアクションログを保持すること

### 要件15

**ユーザーストーリー:** 開発者として、将来のAPI変更に柔軟に対応できるシステムを構築したい。長期的な保守性と拡張性を確保するために。

#### 受入基準

1. 新機能に対応するとき、システムは新しいモデルタイプの自動検出機能を実装すること
2. ソートオプションが追加されるとき、システムは新しいソートオプションへ動的に対応すること
3. API仕様が変更されるとき、システムは柔軟な適応メカニズムを通じて継続的に動作すること
4. 拡張を実装するとき、システムはプラグイン形式での機能拡張をサポートすること
5. ページネーションを処理するとき、システムはカーソルベースページネーションを必須とし、データ欠落リスクを回避すること
6. 制約に対応するとき、システムは公式ドキュメント未記載機能60%への依存リスクを考慮した設計を行うこと

## 非機能要件

### 要件16

**ユーザーストーリー:** システム管理者として、高いパフォーマンスと効率的なリソース利用を確保したい。大量のモデルを安定して処理するために。

#### 受入基準

1. API呼び出しを実行するとき、システムは30秒のタイムアウトを設定し、ダウンロードには5分のタイムアウトを適用すること
2. APIレスポンスを処理するとき、システムは15分間のキャッシュを実装して重複リクエストを削減すること
3. ダウンロードを実行するとき、システムは同時ダウンロード数を1に制限し、API呼び出し間隔を最小2秒に設定してレート制限を回避すること
4. ページングを処理するとき、システムは最大200件/ページ、デフォルト100件/ページの設定を使用すること
5. バッチ処理を実行するとき、システムは個別処理の必須実装によりバルク操作不可の制約に対応すること
6. リソースを管理するとき、システムは最大同時リクエスト数を1に制限してAPI制限を遵守すること

### 要件17

**ユーザーストーリー:** 運用担当者として、システムの高い信頼性と安定性を維持したい。継続的なサービス提供とデータの完全性を確保するために。

#### 受入基準

1. システムを運用するとき、非公式機能のフォールバック成功率90%以上、API制限エラーの自動回復率95%以上を達成すること
2. システムの可用性を維持するとき、99%以上の稼働率を確保すること
3. エラーが発生するとき、システムはネットワークエラー、API認証エラー、レート制限エラーを適切に処理し、必要に応じて自動リトライを実行すること
4. 非公式機能が失敗するとき、システムは段階的デグレード（拡張→公式→基本）を実装すること
5. データを保護するとき、システムはダウンロード中断時のファイル破損を防止し、メタデータとファイルの整合性を確保すること
6. ページネーションを使用するとき、システムはカーソルベース方式によりデータ欠落を完全に防止すること

### 要件18

**ユーザーストーリー:** セキュリティ管理者として、システムの完全なセキュリティと監査機能を確保したい。機密情報の保護とコンプライアンス要件を満たすために。

#### 受入基準

1. 認証情報を管理するとき、システムはAPIキーを環境変数で、CivitAIログイン情報を.envファイルで安全に管理すること
2. セッション情報を保存するとき、システムはCookieを安全に保存し、オプションで認証情報の暗号化保存を提供すること
3. プライバシーを保護するとき、システムは個人情報を含む可能性のあるモデルを識別し、セレブリティカテゴリモデルに特別な注意を払うこと
4. 履歴データを管理するとき、システムはダウンロード履歴のプライバシー保護機能を実装し、ユーザー生成コンテンツを適切に処理すること
5. 監査を実行するとき、システムはセキュリティ関連のアクションログを保持し、アクセス履歴を記録すること
6. 異常を検知するとき、システムは異常動作を自動的に検知し、管理者に通知すること

### 要件19

**ユーザーストーリー:** エンドユーザーとして、使いやすく理解しやすいシステムを利用したい。効率的にタスクを完了し、問題を迅速に解決するために。

#### 受入基準

1. ドキュメントを提供するとき、システムはインストール手順書、使用方法ガイド、API設定手順、トラブルシューティングガイドを含む包括的な文書を用意すること
2. エラーが発生するとき、システムは日本語でわかりやすいエラーメッセージを表示し、具体的な解決方法を提示すること
3. エラー情報を表示するとき、システムはコンテキスト付きの詳細な情報を提供して問題の特定を支援すること
4. CLIを使用するとき、システムは直感的なコマンド体系を提供し、各コマンドの用途を明確にすること
5. 処理を実行するとき、システムは進捗状況を視覚的に表示してユーザーに現在の状態を通知すること
6. ヘルプを求めるとき、システムは充実したヘルプ機能を提供して各機能の使用方法を説明すること

### 要件20

**ユーザーストーリー:** システム開発者として、将来の変更に柔軟に対応できる拡張可能なシステムを構築したい。新機能の追加と既存機能の改善を効率的に行うために。

#### 受入基準

1. 新しいモデルタイプが追加されるとき、システムは自動的に検出して対応すること
2. ソートオプションが変更されるとき、システムは新しいオプションに動的に対応すること
3. API仕様が変更されるとき、システムは柔軟な適応メカニズムを通じて既存機能への影響を最小限に抑えること
4. 機能を拡張するとき、システムはプラグイン形式での追加をサポートし、コアシステムの変更を不要にすること
5. 後方互換性を維持するとき、システムは既存の設定ファイルのマイグレーション機能を提供すること
6. データ形式が変更されるとき、システムは自動的な変換機能を提供して既存データの継続利用を可能にすること

## 制約事項

### 技術的制約

1. **プラットフォーム**
   - Python 3.8以上
   - Civitai API v1の仕様に準拠
   - インターネット接続必須

2. **API仕様制約**
   - オフセットベースページネーション（pageパラメータ）のデータ欠落リスク
   - 公式ドキュメント未記載機能の60%依存リスク
   - sortByシステムの構文変更可能性
   - カテゴリシステムのタグ内統合による複雑性

3. **性能制約**
   - バルク操作不可（個別処理のみ）
   - 最大ページサイズ200件の制限
   - レート制限による処理速度制約

### 運用制約

1. **前提条件**
   - Civitai APIキーの事前取得が必要
   - ローカルストレージの空き容量（モデル1つあたり2-8GB）
   - 安定したインターネット接続

2. **ライセンス**
   - 商用利用可能モデルの識別と適切な処理
   - ライセンス条件の遵守
   - 著作権情報の保持

## 用語定義

### 基本用語

- **Checkpoint**: ベースモデル（完全な画像生成モデル）
- **LoRA**: Low-Rank Adaptation（軽量な追加学習モデル）
- **LoCon**: LyCORISのAPI内部表記
- **DoRA**: Direction-Oriented Adaptation（方向指向適応モデル）
- **TextualInversion**: テキスト埋め込みモデル
- **safetensors**: 安全性を重視したモデルファイル形式
- **Pickle**: 従来型のモデルファイル形式（セキュリティリスクあり）

### API関連用語

- **カーソルベースページネーション**: データの一貫性を保証するページング方式
- **フォールバック**: 機能失敗時の代替処理への自動切り替え
- **sortBy**: 高度なカスタムソート機能の内部パラメータ
- **カテゴリ**: モデルの用途別分類（タグシステム内に統合）
- **非公式機能**: APIドキュメント未記載だが利用可能な機能
- **デュアル検索戦略**: 直接タグ検索とベースモデルフィルタリングの組み合わせ

### セキュリティ用語

- **NSFWコンテンツ**: Not Safe For Work（職場閲覧不適切）コンテンツ
- **Pickleスキャン**: Pythonオブジェクトのセキュリティチェック
- **ハッシュアルゴリズム**: ファイル整合性検証用の暗号学的ハッシュ関数

## 成功基準

### 機能面の成功基準

1. **検索精度**
   - 指定条件のモデルを95%以上の精度で検索
   - カテゴリ×タグ×タイプの3重フィルタリング精度98%以上
   - 重複除去の正確性99%以上

2. **データ収集**
   - 85以上のAPIフィールドの完全取得
   - 全13種類のモデルタイプの正確な識別
   - 15カテゴリの適切な分類

3. **ダウンロード性能**
   - ダウンロード成功率90%以上
   - 中断後の再開成功率95%以上
   - ファイル整合性検証成功率100%

### 非機能面の成功基準

1. **信頼性**
   - エラー発生時の自動復旧率80%以上
   - 公式・非公式機能の適切な使い分けによる機能カバレッジ95%以上
   - 非公式機能のフォールバック成功率90%以上

2. **性能**
   - API応答時間30秒以内の達成率99%
   - キャッシュヒット率50%以上
   - メモリ使用量の安定性

3. **セキュリティ**
   - セキュリティスキャン警告の100%表示
   - 認証情報漏洩件数0件
   - プライバシー侵害インシデント0件

### ユーザビリティの成功基準

1. **使いやすさ**
   - コマンド実行成功率95%以上
   - エラーメッセージの理解度90%以上
   - ヘルプ機能の有用性評価4.0/5.0以上

2. **拡張性**
   - 新機能追加時の既存機能影響0件
   - API変更への適応時間24時間以内
   - プラグイン統合成功率90%以上